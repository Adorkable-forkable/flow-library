
<div class="grid"  style="padding-top: 10px;">
    <div class="col-1-1">
        <div class="gist-filter">
            <input class="gist-filter-input" type="text" value="{{query.term}}" placeholder="Search library"/>
            <ul class="gistbox-filter-options">
                <li><input id="gistbox-filter-option-flows" data-filter="flows" class="gistbox-filter-option" checked type="checkbox" /><label class="gistbox-filter-label" for="gistbox-filter-option-flows">flows</label></li>
                <li><input id="gistbox-filter-option-nodes" data-filter="nodes" class="gistbox-filter-option" checked type="checkbox" /><label class="gistbox-filter-label" for="gistbox-filter-option-nodes">nodes</label></li>
            </ul>
            <span class="gist-count">{{count}} of {{total}} things</span>
        </div>
        <div class="gist-sort">
            <span>Sort by:</span>
            <span>
                <div><input class="gistbox-sort-option" id="gistbox-sort-option-recent" checked type="radio" name="sort-option" value="recent"> <label class="gistbox-sort-label" for="gistbox-sort-option-recent">recent</label></div>
                <div><input class="gistbox-sort-option" id="gistbox-sort-option-downloads" type="radio" name="sort-option" value="downloads"> <label class="gistbox-sort-label" for="gistbox-sort-option-downloads">downloads</label></div>
                <div><input class="gistbox-sort-option" id="gistbox-sort-option-rating" type="radio" name="sort-option" value="rating"> <label class="gistbox-sort-label" for="gistbox-sort-option-rating">rating</label></div>
            </span>
        </div>
    </div>
</div>

<div class="grid main-content">
    <div class="col-1-1">
        <ul class="gistlist">
        {{#things}}
            {{#_rev}}{{>_nodebox}}{{/_rev}}
            {{^_rev}}{{>_gistbox}}{{/_rev}}
        {{/things}}
        </ul>
    </div>
    {{#prevPage}}<a class="page-prev" href="#">&lt;&nbsp;Prev</a>{{/prevPage}}
    &nbsp;{{query.page}}&nbsp;
    {{#nextPage}}<a class="page-next" href="#">Next&nbsp;&gt;</a>{{/nextPage}}
</div>

<script>

var items = [];
var gistCount = {{total}};
var currentTerm = "{{query.term}}";
var filters = {
    "nodes": false,
    "flows": false
}
var filterType = "{{query.type}}";
switch (filterType) {
    case "all":
    case "":
        filters.flows = true;
        filters.nodes = true;
        break;
    case "flow":
        filters.flows = true;
        break;
    case "node":
        filters.nodes = true;
        break;
}
var sort = "{{query.sort}}";

function generateQueryString() {
    // get the value of each one
    var query = [];
    newUrl = "";
    if (sort) query.push("sort="+sort);
    if (currentTerm) query.push("term="+currentTerm);
    if (filterType) query.push("type="+filterType);
    newUrl = "?"+query.join('&');
    return newUrl;
}

var currentUrl = generateQueryString();
if (currentUrl != '?') currentUrl += '&';
var prevPage = currentUrl + "page="+{{prevPage}};
var nextPage = currentUrl + "page="+{{nextPage}};

$(function() {

    $(".gistbox-filter-option").each(function(i, filterOption) {
        $(filterOption).prop('checked',filters[$(filterOption).data("filter")]);
    });

    $("input[name=sort-option][value=" + sort + "]").attr('checked', 'checked');

    $(".page-prev").attr('href', prevPage);
    $(".page-next").attr('href', nextPage);

    $(".gist-filter-input").keyup(utils.debounce(function() {
        currentTerm = $(".gist-filter-input").val().toLowerCase();
        window.location = generateQueryString();
    }, 1000));

    $(".gistbox-filter-option").change(function() {
        filters[$(this).data("filter")] = this.checked;
        filterType = "none";
        if (filters.nodes && filters.flows) {
            filterType = "all"
        } else if (filters.nodes) {
            filterType = "node";
        } else if (filters.flows) {
            filterType = "flow";
        }
        window.location = generateQueryString();
    });

    $(".gistbox-sort-option").change(function() {
        sort = $(this).val();
        window.location = generateQueryString();
    });
});
</script>
